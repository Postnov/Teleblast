<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>TeleBlast Admin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 2rem;
            background: #f8f9fa;
            padding-bottom: 100px;
            /* –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ–¥ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
        }
        
        h2 {
            margin-top: 2rem;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            background: #ffffff;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        th {
            background: #e9ecef;
            text-align: left;
        }
        
        tr:hover {
            background: #f6f6f6;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #ffffff;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            padding: 10px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        form {
            display: inline;
        }
        
        input[type=text] {
            padding: 4px;
        }
        
        button {
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        button:hover {
            background: #e9ecef;
        }
        
        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }
        
        .delete-btn:hover {
            background: #c82333 !important;
            border-color: #bd2130 !important;
        }
    </style>
</head>

<body>
    <h1>TeleBlast Admin</h1>

    <h2>–°–µ–≥–º–µ–Ω—Ç—ã</h2>
    <form action="/lists/create" method="post">
        <input type="text" name="name" placeholder="–ù–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç" required />
        <button type="submit">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
    </form>
    <table>
        <tr>
            <th>ID</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        {% for list_id, name in lists %}
        <tr>
            <td>{{ list_id }}</td>
            <td>{{ name }}</td>
            <td>
                <form action="/lists/{{ list_id }}/delete" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫?');">
                    <button type="submit">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <h2>–ì—Ä—É–ø–ø—ã</h2>
    <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∫–æ–ª: <b>{{ total_groups }}</b>. –ü–æ–∫–∞–∑–∞–Ω–æ: <b>{{ groups|length }}</b></p>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–∏—Å–∫–∞–º -->
    <form method="get" style="margin-bottom: 1rem; display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;">
        <div>
            <label for="include_select"><b>–í–∫–ª—é—á–∞—Ç—å (—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω):</b></label><br>
            <select name="include" id="include_select" multiple size="4" style="min-width:160px;">
                {% for list_id, name in lists %}
                    <option value="{{ list_id }}" {% if (include_ids | list) and (list_id|string) in include_ids %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="exclude_select"><b>–ò—Å–∫–ª—é—á–∞—Ç—å (–Ω–∏ –≤ –æ–¥–Ω–æ–º):</b></label><br>
            <select name="exclude" id="exclude_select" multiple size="4" style="min-width:160px;">
                {% for list_id, name in lists %}
                    <option value="{{ list_id }}" {% if (exclude_ids | list) and (list_id|string) in exclude_ids %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px;">
            <label><input type="checkbox" name="unassigned" value="1" {% if unassigned_only %}checked{% endif %}> –¢–æ–ª—å–∫–æ –±–µ–∑ —Å–ø–∏—Å–∫–∞</label>
            <button type="submit" style="padding:6px 12px;">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
            <a href="/" style="text-align:center; font-size:0.9em;">–°–±—Ä–æ—Å</a>
        </div>
    </form>
    <table>
        <tr>
            <th><input type="checkbox" id="select_all" onclick="toggleAll(this)"></th>
            <th>ID</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–°–µ–≥–º–µ–Ω—Ç—ã</th>
            <th>–£–¥–∞–ª–∏—Ç—å</th>
        </tr>
        {% for chat_id, title, list_names in groups %}
        <tr>
            <td><input type="checkbox" form="bulkForm" name="chat_ids" value="{{ chat_id }}"></td>
            <td>{{ chat_id }}</td>
            <td>{{ title }}</td>
            <td>{{ list_names or '‚Äî' }}</td>
            <td>
                <form action="/groups/{{ chat_id }}/delete" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?');">
                    <button type="submit">üóë</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    <div class="bottom-bar">
        <form id="bulkForm" action="/groups/bulk" method="post" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <select name="list_id" id="list_selector">
                    {% for list_id, name in lists %}
                        <option value="{{ list_id }}">{{ name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" name="action" value="assign">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                <button type="submit" name="action" value="unassign">‚ûñ –£–±—Ä–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
            </div>
            <div style="border-left: 1px solid #ddd; padding-left: 8px;">
                <button type="submit" name="action" value="delete" class="delete-btn" onclick="return confirmBulkDelete()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
            </div>
        </form>
    </div>
    <script>
        function toggleAll(source) {
            const checkboxes = document.getElementsByName('chat_ids');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
            }
        }

        function confirmBulkDelete() {
            const checked = document.querySelectorAll('input[name="chat_ids"]:checked');
            if (checked.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return false;
            }

            const groupNames = Array.from(checked).map(cb => {
                const row = cb.closest('tr');
                const title = row.cells[2].textContent; // –ö–æ–ª–æ–Ω–∫–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ"
                const id = row.cells[1].textContent; // –ö–æ–ª–æ–Ω–∫–∞ "ID"
                return `${title} (${id})`;
            });

            const message = `–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ò–¢–¨ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–ª–µ–¥—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã:\n\n${groupNames.join('\n')}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
            return confirm(message);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±–æ—Ä —Å–ø–∏—Å–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–æ–≤
        document.getElementById('bulkForm').addEventListener('submit', function(e) {
            const action = e.submitter.value;
            const listSelector = document.getElementById('list_selector');

            if ((action === 'assign' || action === 'unassign') && !listSelector.value) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏');
                e.preventDefault();
                return false;
            }

            // –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è —É–±–∏—Ä–∞–µ–º required —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Å–ø–∏—Å–∫–∞
            if (action === 'delete') {
                listSelector.removeAttribute('required');
            } else {
                listSelector.setAttribute('required', 'required');
            }
        });

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedPos = sessionStorage.getItem('scrollPos');
            if (savedPos !== null) {
                window.scrollTo(0, parseInt(savedPos));
            }
        });
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('scrollPos', window.scrollY);
        });
    </script>
</body>

</html>