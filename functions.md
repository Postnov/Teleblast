# Документация функций TeleBlast

## Функции базы данных (database.py)

### delete_group(self, chat_id: int)
**Назначение**: Полностью удаляет группу из базы данных вместе с её привязками к сегментам
**Входные параметры**: 
- `chat_id` (int) - ID чата/группы в Telegram
**Что делает**: Удаляет записи из таблиц `list_groups` и `groups`
**Связанные функции**: Используется в веб-приложении и боте для полного удаления групп

### remove_group_from_list(self, chat_id: int, list_id: int)
**Назначение**: Удаляет группу из конкретного сегмента (но не из базы данных)
**Входные параметры**:
- `chat_id` (int) - ID группы
- `list_id` (int) - ID сегмента
**Что делает**: Удаляет связь между группой и сегментом в таблице `list_groups`
**Связанные функции**: Используется в bulk операциях веб-приложения

### assign_group_to_list(self, chat_id: int, list_id: int)
**Назначение**: Добавляет группу в сегмент
**Входные параметры**:
- `chat_id` (int) - ID группы
- `list_id` (int) - ID сегмента
**Что делает**: Создает связь между группой и сегментом в таблице `list_groups`
**Связанные функции**: Используется в bulk операциях веб-приложения

### get_groups_with_lists(self)
**Назначение**: Получает сегмент всех групп с их привязками к сегментам
**Входные параметры**: Нет
**Что делает**: Возвращает группы с названиями сегментов, к которым они привязаны
**Связанные функции**: Используется на главной странице веб-приложения

### create_list(self, name: str)
**Назначение**: Создает новый сегмент
**Входные параметры**:
- `name` (str) - название сегмента
**Что делает**: Добавляет новый сегмент в таблицу `lists`
**Связанные функции**: Используется в веб-форме создания сегментов

### delete_list(self, list_id: int)
**Назначение**: Удаляет сегмент из базы данных
**Входные параметры**:
- `list_id` (int) - ID сегмента
**Что делает**: Удаляет сегмент и все его связи с группами
**Связанные функции**: Используется в веб-приложении для удаления сегментов

## Функции веб-приложения (webapp/app.py)

### authenticate(credentials: HTTPBasicCredentials)
**Назначение**: Проверяет аутентификацию пользователя для доступа к админ-панели
**Входные параметры**:
- `credentials` (HTTPBasicCredentials) - объект с логином и паролем из HTTP Basic Auth
**Что делает**: 
- Сравнивает введенные логин/пароль с настройками из config.py
- Использует безопасное сравнение через `secrets.compare_digest`
- Возвращает HTTP 401 если данные неверны
**Связанные функции**: Используется как dependency во всех защищенных роутах веб-приложения
**Настройки**: Использует `WEBAPP_USERNAME` и `WEBAPP_PASSWORD` из переменных окружения

### delete_group(chat_id: int)
**Назначение**: Веб-роут для удаления отдельной группы
**Входные параметры**:
- `chat_id` (int) - ID группы для удаления
**Что делает**: Вызывает `db.delete_group()` и перенаправляет на главную страницу
**Связанные функции**: Связана с `database.delete_group()`

### bulk_groups(request: Request)
**Назначение**: Обрабатывает массовые операции с группами
**Входные параметры**:
- `request` (Request) - HTTP запрос с формой
**Что делает**: В зависимости от действия (`assign`, `unassign`, `delete`) выполняет операции над выбранными группами
**Связанные функции**: Использует `db.assign_group_to_list()`, `db.remove_group_from_list()`, `db.delete_group()`

### create_list(name: str)
**Назначение**: Веб-роут для создания нового сегмента
**Входные параметры**:
- `name` (str) - название сегмента из формы
**Что делает**: Создает новый сегмент через `db.create_list()`
**Связанные функции**: Связана с `database.create_list()`

### assign_group(chat_id: int, list_id: int)
**Назначение**: Веб-роут для привязки группы к списку
**Входные параметры**:
- `chat_id` (int) - ID группы
- `list_id` (int) - ID сегмента
**Что делает**: Привязывает группу к списку через `db.assign_group_to_list()`
**Связанные функции**: Связана с `database.assign_group_to_list()`

### unassign_group(chat_id: int, list_id: int)
**Назначение**: Веб-роут для отвязки группы от сегмента
**Входные параметры**:
- `chat_id` (int) - ID группы
- `list_id` (int) - ID сегмента
**Что делает**: Отвязывает группу от сегмента через `db.remove_group_from_list()`
**Связанные функции**: Связана с `database.remove_group_from_list()`

### index(request: Request)
**Назначение**: Главная страница с фильтрацией групп
**Входные параметры**:
- `request` (Request) - HTTP запрос с параметрами фильтрации
**Что делает**: Отображает группы с возможностью фильтрации по сегментам
**Связанные функции**: Использует `db.get_lists()`, `db.get_groups_with_lists()`

## Функции бота (bot.py)

### cmd_refresh(message: types.Message)
**Назначение**: Команда `/refresh` - принудительно обновляет списки сегментов из базы данных
**Входные параметры**:
- `message` (types.Message) - сообщение от пользователя
**Что делает**: Загружает актуальные сегменты из БД и выводит их количество и названия
**Связанные функции**: Использует `db.get_lists()` для получения свежих данных

## JavaScript функции (webapp/templates/index.html)

### toggleAll(source)
**Назначение**: Выбирает/снимает выбор со всех чекбоксов групп
**Входные параметры**:
- `source` (Element) - чекбокс "Выбрать все"
**Что делает**: Синхронизирует состояние всех чекбоксов с главным
**Связанные функции**: Используется с bulk операциями

### confirmBulkDelete()
**Назначение**: Показывает подтверждение перед массовым удалением групп
**Входные параметры**: Нет (читает выбранные чекбоксы)
**Что делает**: Отображает сегмент групп для удаления и запрашивает подтверждение
**Связанные функции**: Используется с кнопкой массового удаления

### bulkForm submit handler
**Назначение**: Проверяет корректность формы перед отправкой
**Входные параметры**: Event объект
**Что делает**: Проверяет выбор сегмента для операций assign/unassign, убирает required для delete
**Связанные функции**: Работает с функцией `bulk_groups` на сервере

## Основные связи между функциями

1. **Удаление групп**: `delete_group` (веб) → `database.delete_group` → обновление БД
2. **Массовые операции**: `bulk_groups` (веб) → различные методы database в зависимости от действия
3. **Фильтрация**: `index` (веб) → `database.get_groups_with_lists` → отображение
4. **UI взаимодействие**: JavaScript функции → веб-роуты → database методы 

## Утилиты управления проектом

### start_webapp.py
**Назначение**: Скрипт для запуска веб-приложения административной панели
**Входные параметры**: Нет (настройки читаются из config.py)
**Что делает**:
- Проверяет наличие директории webapp
- Выводит информацию о запуске
- Запускает webapp/app.py через subprocess
- Обрабатывает ошибки и Ctrl+C
**Связанные функции**: Используется в Makefile команде `make start-webapp`

### Makefile
**Назначение**: Автоматизация управления ботом и веб-приложением
**Основные команды**:
- `make start-bot` - запуск бота в фоне через nohup
- `make stop-bot` - остановка бота через pkill (с проверкой процессов)
- `make start-webapp` - запуск веб-панели через start_webapp.py
- `make stop-webapp` - остановка веб-панели (включая uvicorn процессы и принудительное освобождение порта 8000)
- `make force-stop` - принудительная остановка процессов проекта (не все Python процессы)
- `make kill-safe` - безопасная остановка только bot.py и app.py с мягким завершением
- `make cleanup-pids` - очистка устаревших PID-файлов (bot.pid, webapp.pid)
- `make status` - проверка статуса процессов через PID-файлы
- `make logs` - просмотр логов
- `make create-venv` - создание виртуального окружения
- `make setup` - первичная настройка проекта (включает создание venv)
- `make start-all` - запуск бота и веб-панели
- `make stop-all` - остановка всех процессов

**Исправления ошибок**:
- Команда `stop-webapp` теперь корректно останавливает uvicorn процессы
- Добавлена принудительная очистка порта 8000 при ошибке "Address already in use"
- **Система PID-файлов**: команды управления ботом (start-bot, stop-bot, status) теперь используют файлы bot.pid и webapp.pid для точного отслеживания процессов
- **Устранение ложных срабатываний**: команды больше НЕ видят "мёртвые" или зависшие процессы, только активные
- **Безопасная остановка**: использование `kill -0` для проверки существования процесса перед остановкой
- **Фильтрация по директории**: все команды (status, start-bot, stop-bot, stop-webapp, kill-teleblast) теперь работают только с процессами, запущенными из `/home/teleblast` (переменная PROJECT_DIR)
- Команды больше НЕ видят процессы из Docker контейнеров других ботов
- Команда `status` показывает только локальные процессы TeleBlast
- Команда `force-stop` избирательно останавливает только процессы проекта, не все Python процессы
- Команда `kill-safe` использует мягкое завершение (SIGTERM) перед принудительным (SIGKILL)
- **Безопасная остановка процессов**: добавлены проверки валидности PID (не пустой, больше 0) перед вызовом kill
- Все команды остановки используют двухэтапный процесс: SIGTERM (мягкое завершение), затем SIGKILL (принудительное)
- Добавлена поддержка создания виртуального окружения
- Исправлена проблема с множественными экземплярами бота (Telegram Flood Control)
- **Полностью устранена ошибка "Terminated"** при выполнении команд остановки

**Проблема Telegram Flood Control**:
Множественные экземпляры бота вызывают ошибки "Flood control exceeded" в Telegram API.
Это происходит когда несколько ботов одновременно делают запросы getUpdates.
Решение: обязательно останавливать все экземпляры перед новым запуском через `make kill-teleblast`.

**Система PID-файлов**:
Команды управления ботом используют файлы `bot.pid` и `webapp.pid` для точного отслеживания процессов:
- При запуске бота PID сохраняется в файл
- При проверке статуса читается PID из файла и проверяется активность процесса (`kill -0`)
- При остановке используется точный PID из файла, а не поиск по командной строке
- Автоматическая очистка устаревших PID-файлов через `make cleanup-pids`

**Фильтрация процессов по директории**:
Все команды Makefile теперь используют проверку рабочей директории процесса (`/proc/PID/cwd`) для фильтрации только процессов TeleBlast, запущенных из директории проекта. Это исключает ложные срабатывания на другие боты.

**Связанные файлы**: 
- Использует start_webapp.py для запуска веб-приложения
- Создает bot.log для логов бота
- Работает с .env файлом через команду setup
- Создает и управляет виртуальным окружением venv/

## Утилита очистки базы данных

### clear_database.py
**Назначение**: Скрипт для полной очистки базы данных TeleBlast после тестирования
**Входные параметры**: Нет (интерактивное подтверждение)
**Что делает**:
- Показывает текущую статистику базы данных
- Запрашивает двойное подтверждение пользователя
- Очищает все таблицы в правильном порядке (с учетом внешних ключей)
- Выводит результат операции
**Связанные функции**: Использует класс Database для подключения к БД

**Порядок очистки таблиц**:
1. `broadcast_messages` - сообщения рассылок
2. `broadcasts` - рассылки
3. `list_groups` - связи групп и сегментов
4. `groups` - группы
5. `lists` - сегменты

**Использование**:
```bash
python clear_database.py
```

**Безопасность**:
- Требует подтверждения "да/нет"
- Требует ввода слова "УДАЛИТЬ" заглавными буквами
- Показывает статистику до очистки
- Проверяет результат после очистки 